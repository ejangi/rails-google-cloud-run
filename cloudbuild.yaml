steps:

# Build and tag the image.
- name: 'gcr.io/cloud-builders/docker'
  id: Build
  args: [ 'build', '-t', 'gcr.io/cloud-run-test/rails-google-cloud-run', '.' ]
  env:
    - 'RAILS_ENV=${_RAILS_ENV}'

- name: 'gcr.io/cloud-builders/docker'
  id: Push
  args: ['push', 'gcr.io/cloud-run-test/rails-google-cloud-run']

# Deploy
- name: 'gcr.io/cloud-builders/gcloud'
  id: Deploy
  args: [ 'beta', 'run', 'deploy', 'rails-google-cloud-run', '--image', 'gcr.io/cloud-run-test/rails-google-cloud-run', '--platform', 'managed', '--region', '${_REGION}' ]
  env:
    - 'RAILS_ENV=${_RAILS_ENV}'
